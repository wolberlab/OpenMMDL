{% extends "layout.html" %}

{% macro fileinput(id) %}
    <div class="input-group">
        <label class="btn btn-default btn-file input-group-addon">
            <span title="Select File"style=" font-weight: 700;">Browse... </span>
            <input type="file" name="{{ id }}" id="{{ id }}" style="display: none" onchange="optionChanged()"/>
        </label>
        <span id="{{ id }}_label" class="form-control"/>
    </div>
{% endmacro %}

{% block title %}Select Input Files{% endblock %}
{% block body %}
</style>


Select the pdb input file and options for how to model it.
<p/>

<form method="post" enctype="multipart/form-data" action="{{ url_for('configureFiles') }}" class="form-horizontal">
    <div class="form-group">
    <label for="filename" class="control-label col-md-2">PDB File</label>
        <div class="col-md-10">{{ fileinput('file') }}</div>
    </div>
    <div class="form-group">
    <label for="forcefield" class="control-label col-md-2">Force Field</label>
    <div class="col-md-10"><select name="forcefield" id="forcefield" class="form-control" title="CHARMM force field does not support ligands. Select Amber force fields for ligand-protein MD simulations" onchange="optionChanged()">
        <option value="AMBER19" selected>AMBER19</option> 
        <option value="AMBER14">AMBER14</option>
        <option value="AMBER99SB">AMBER99SB</option>
        <option value="AMBER99SB-ILDN">AMBER99SB-ILDN</option>
        <option value="AMBER03">AMBER03</option>
        <option value="AMBER10">AMBER10</option>
        <option value="CHARMM36">CHARMM36</option>
        <option value="CHARMM2024">CHARMM36 2024</option>
    </select></div>
    </div>
    <div id="waterModelRow" class="form-group">
        <label for="waterModel" class="control-label col-md-2">Water Model</label>
        <div class="col-md-10"><select name="waterModel" id="waterModel" class="form-control" title="TIP3P, TIP3P-FB and SPC/E are the most tested water models in OpenMMDL "></select></div>
    </div>
    <p>
    Optional : Add ligand SDF file to the MD simulation (Default: No ligand)
    </p>
    <div class="form-group">
    <label for="filename" class="control-label col-md-2">Ligand File</label>
        <div class="col-md-10" title="The supported formats are SDF, MOL and MOL2"> {{fileinput('sdfFile') }}</div>
    </div>
    <div class="form-group">
    <label for="smallMoleculeForceField" class="control-label col-md-2">Small Molecule Force Field</label>
    <div class="col-md-10"><select name="smallMoleculeForceField" id="smallMoleculeForceField" class="form-control" title="Select the preferred small molecule force field" onchange="optionChanged()">
        <option value="gaff" selected>GAFF</option>
        <option value="smirnoff">SMIRNOFF</option>
    </select></div>
    </div>
    <div id="gaffVersionRow" class="form-group" hidden>
        <label for="gaffVersion" class="control-label col-md-2">GAFF Version</label>
        <div class="col-md-10">
            <select name="gaffVersion" id="gaffVersion" class="form-control" onchange="optionChanged()"></select>
        </div>
    </div>
    <div id="smirnoffConstraintRow" class="form-group" hidden>
        <label for="openffConstraint" class="control-label col-md-2">SMIRNOFF Mode</label>
        <div class="col-md-10">
            <select name="openffConstraint" id="openffConstraint" class="form-control" onchange="optionChanged()">
                <option value="constrained" selected>Constrained</option>
                <option value="unconstrained">Unconstrained</option>
            </select>
        </div>
    </div>
    <div id="smirnoffVersionRow" class="form-group" hidden>
        <label for="openffVersion" class="control-label col-md-2">SMIRNOFF Version</label>
        <div class="col-md-10">
            <select name="openffVersion" id="openffVersion" class="form-control" onchange="optionChanged()"></select>
        </div>
    </div>
    <div class="form-group">
    <label for="ligandMinimization" class="control-label col-md-2">Ligand Minimization</label>
    <div class="col-md-10"><select name="ligandMinimization" id="ligandMinimization" class="form-control" title="Minimize ligand with MMFF94 rdkit without protein" onchange="optionChanged()">
        <option value="False" selected>No</option>
        <option value="True">Yes</option>
    </select></div>
    </div>
    <div class="form-group">
    <label for="ligandSanitization" class="control-label col-md-2">
        <span style=" font-weight: 700" title="Depending on the ligand the Sanitization can be required for OpenMM or may lead to errors in case of specific ligand substructures (example: Thiopene)"">Ligand Sanitization</span>
    </label>
    <div class="col-md-10"><select name="ligandSanitization" id="ligandSanitization" class="form-control" title="Sanitize ligand with rdkit" onchange="optionChanged()">
        <option value="False" selected>No</option>
        <option value="True">Yes</option>
    </select></div>
    </div>
    <br/>
    <input type="submit" value="Continue" id="continue" class="btn" disabled="true"/>
</form>
<script>
var newAmberWaterModels = [
        ["TIP3P", "TIP3P", true],
        ["TIP3P-FB", "TIP3P-FB", false],
        ["SPC/E", "SPC/E", false],
        ["TIP4P-Ew", "TIP4P-Ew", false],
        ["TIP4P-FB", "TIP4P-FB", false],
        ["OPC3", "OPC3", false],
        ["OPC", "OPC", false],
]

var charmmWaterModels = [
        ["CHARMM default", "CHARMM default", true],
        ["TIP3P-PME-B", "TIP3P-PME-B", false],
        ["TIP3P-PME-F", "TIP3P-PME-F", false],
        ["SPC/E", "SPC/E", false],
        ["TIP4P-Ew", "TIP4P-Ew", false],
        ["TIP4P-2005", "TIP4P-2005", false],
        ["TIP5P", "TIP5P", false],
        ["TIP5P-Ew", "TIP5P-Ew", false],
]

var gaffVersions = [
        ["gaff-2.2.20", "GAFF 2.2.20", true],
        ["gaff-2.11", "GAFF 2.11", false],
        ["gaff-2.1", "GAFF 2.1", false],
        ["gaff-1.81", "GAFF 1.81", false],
        ["gaff-1.8", "GAFF 1.8", false],
        ["gaff-1.4", "GAFF 1.4", false],
]

var openffVersionsDefault = [
        ["openff_no_water-3.0.0-alpha0.offxml", "OpenFF 3.0 no water (ALPHA version – may be unstable)", false],
        ["openff-2.2.1.offxml", "OpenFF 2.2.1", true],
        ["openff-2.2.0.offxml", "OpenFF 2.2.0", false],
        ["openff-2.1.1.offxml", "OpenFF 2.1.1", false],
        ["openff-2.1.0.offxml", "OpenFF 2.1.0", false],
        ["openff-2.0.0.offxml", "OpenFF 2.0.0", false],
        ["openff-1.3.1.offxml", "OpenFF 1.3.1", false],
        ["openff-1.3.0.offxml", "OpenFF 1.3.0", false],
        ["openff-1.2.1.offxml", "OpenFF 1.2.1", false],
        ["openff-1.2.0.offxml", "OpenFF 1.2.0", false],
        ["openff-1.1.1.offxml", "OpenFF 1.1.1", false],
        ["openff-1.1.0.offxml", "OpenFF 1.1.0", false],
        ["openff-1.0.1.offxml", "OpenFF 1.0.1", false],
        ["openff-1.0.0.offxml", "OpenFF 1.0.0", false],
]

var openffVersionsUnconstrained = [
        ["openff_no_water_unconstrained-3.0.0-alpha0.offxml", "OpenFF 3.0 no water unconstrained (ALPHA version – may be unstable)", false],
        ["openff_unconstrained-2.2.1.offxml", "OpenFF 2.2.1 unconstrained", true],
        ["openff_unconstrained-2.2.0.offxml", "OpenFF 2.2.0 unconstrained", false],
        ["openff_unconstrained-2.1.1.offxml", "OpenFF 2.1.1 unconstrained", false],
        ["openff_unconstrained-2.1.0.offxml", "OpenFF 2.1.0 unconstrained", false],
        ["openff_unconstrained-2.0.0.offxml", "OpenFF 2.0.0 unconstrained", false],
        ["openff_unconstrained-1.3.1.offxml", "OpenFF 1.3.1 unconstrained", false],
        ["openff_unconstrained-1.3.0.offxml", "OpenFF 1.3.0 unconstrained", false],
        ["openff_unconstrained-1.2.1.offxml", "OpenFF 1.2.1 unconstrained", false],
        ["openff_unconstrained-1.2.0.offxml", "OpenFF 1.2.0 unconstrained", false],
        ["openff_unconstrained-1.1.1.offxml", "OpenFF 1.1.1 unconstrained", false],
        ["openff_unconstrained-1.1.0.offxml", "OpenFF 1.1.0 unconstrained", false],
        ["openff_unconstrained-1.0.1.offxml", "OpenFF 1.0.1 unconstrained", false],
        ["openff_unconstrained-1.0.0.offxml", "OpenFF 1.0.0 unconstrained", false],
]

var oldAmberWaterModels = [
        ["TIP3P", "TIP3P", true],
        ["TIP3P-FB", "TIP3P-FB", false],
        ["SPC/E", "SPC/E", false],
        ["TIP4P-Ew", "TIP4P-Ew", false],
        ["TIP5P", "TIP5P", false],
        ["OPC3", "OPC3", false],
        ["OPC", "OPC", false],
]

var amoebaWaterModels = [
        ["Explicit", "Explicit", true],
        ["Implicit", "Implicit", false]
]

function populateSelect(selectEl, models, currentValue) {
    // models = [ [value, label, isDefault], ... ]
    while (selectEl.length > 0) selectEl.remove(0);

    for (let i = 0; i < models.length; i++) {
        const opt = document.createElement("option");
        opt.value = models[i][0];
        opt.text  = models[i][1];
        selectEl.add(opt);
    }

    // Default selection (first flagged default)
    for (let i = 0; i < models.length; i++) {
        if (models[i][2]) { selectEl.selectedIndex = i; break; }
    }

    // Preserve current selection if it exists in the new model list
    if (currentValue) {
        for (let i = 0; i < models.length; i++) {
            if (currentValue === models[i][0]) { selectEl.selectedIndex = i; break; }
        }
    }
}

function optionChanged() {
    // ----- Forcefield / water handling (your existing logic) -----
    forcefield = document.getElementById("forcefield").value;
    waterSelect = document.getElementById("waterModel");
    currentWater = waterSelect.value;

    if (forcefield == 'CHARMMPOLAR2019')
        document.getElementById("waterModelRow").hidden = true;
    else {
        document.getElementById("waterModelRow").hidden = false;
        if (forcefield == "AMBER14")
            models = newAmberWaterModels;
        else if (forcefield == "AMBER19")
            models = newAmberWaterModels;
        else if (forcefield == "CHARMM36")
            models = charmmWaterModels;
        else if (forcefield == "CHARMM2024")
            models = charmmWaterModels;
        else if (forcefield == "AMOEBA2018")
            models = amoebaWaterModels;
        else
            models = oldAmberWaterModels;

        populateSelect(waterSelect, models, currentWater);
    }

    // ----- Small molecule FF conditional UI -----
    const smff = document.getElementById("smallMoleculeForceField").value;

    const gaffVersionRow = document.getElementById("gaffVersionRow");
    const smirnoffConstraintRow = document.getElementById("smirnoffConstraintRow");
    const smirnoffVersionRow = document.getElementById("smirnoffVersionRow");

    const gaffVersionSelect = document.getElementById("gaffVersion");
    const openffConstraintSelect = document.getElementById("openffConstraint");
    const openffVersionSelect = document.getElementById("openffVersion");

    if (smff === "gaff") {
        gaffVersionRow.hidden = false;
        smirnoffConstraintRow.hidden = true;
        smirnoffVersionRow.hidden = true;

        populateSelect(gaffVersionSelect, gaffVersions, gaffVersionSelect.value);
    } else if (smff === "smirnoff") {
        gaffVersionRow.hidden = true;
        smirnoffConstraintRow.hidden = false;
        smirnoffVersionRow.hidden = false;

        const mode = openffConstraintSelect.value; // constrained | unconstrained
        const models = (mode === "unconstrained") ? openffVersionsUnconstrained : openffVersionsDefault;

        populateSelect(openffVersionSelect, models, openffVersionSelect.value);
    } else {
        // In case more options are added later
        gaffVersionRow.hidden = true;
        smirnoffConstraintRow.hidden = true;
        smirnoffVersionRow.hidden = true;
    }

    // ----- File label + submit enable (your existing logic) -----
    files = document.getElementById("file").files;
    sdfFile = document.getElementById("sdfFile").files;

    document.getElementById("file_label").textContent = (files.length == 0 ? "" : files[0].name);
    document.getElementById("sdfFile_label").textContent = (sdfFile.length == 0 ? "" : sdfFile[0].name);

    document.getElementById('continue').disabled = !document.getElementById("file").value;
}

optionChanged();
</script>

{% endblock %}
