**Running OpenMMDL-Analysis**
=============================

OpenMMDL-Analysis can be used to analyze MD trajectories for receptor ligand interactions.

This page details the variables required to run the analysis and showcases the application of OpenMMDL-Analysis.

Variables
------------------------------
OpenMMDL-Analysis consists of mandatory and optional variables. The following are listed down below:


Mandatory:

.. code-block:: text

    -t = topology file of the simulation (in .pdb format)
    -d = trajectory file of the simulation (in .dcd format)
    -l = ligand by itself as reference for the analysis (in .sdf format)
    -n = name of the ligand in the topology file 

Optional:

.. code-block:: text

    -b = binding mode treshold. Is used to remove interactions under the defined procentual occurence from the binding mode generation. The default is 40% (accepted values: 0-100)
    -df = dataframe file. Can be used if previous analysis was allready performed and the dataframe file is available. This will skip the analysis of the trajectory and go straight to the output generation. The default name of this file is "interactions_gathered.csv"
    -m = minimal transition threshold. Is used for the display of the binding mode transitions in the markov state chains network figure. The default value is 1
    -c = CPU count. The number of CPU's to be used for interaction calculation. The default is is half of the available CPU's
    -p = output .pml files. This will generate .pml files for each binding mode as well as a .pml of the point clouds. The default is False (accepted values: True/False)

Application
------------------------------
An example of how a command line input for OpenMMDL-Analysis should look like is:

.. code-block:: text
    openmmdl_analysis -t topology.pdb -d trajectory.dcd -l ligand.sdf -n 'LIG'

If you need help with the command line input, you can always just use:

.. code-block:: text
    openmmdl_analysis

Results
------------------------------
The results of the analysis with OpenMMDL-Analysis are stored in the current working directory. 

You will optain the following files and folders:

df_all.csv: This is the main source of raw data from the interaction analysis. It contains all the interactions that were found in the trajectory. Each row contains the information for one interaction of one frame.

Barcodes:
    This folder will contain figures of the barcodes for each interaction in form of .png image files. Each interaction type will be stored in a sperate file.
    
    .. figure:: /_static/images/Analysis/donor_barcodes.png
        :figwidth: 725px
        :align: center
    
    Furthermore the "Barcodes" folder will contain a subfolder called "Waterbridge_Piecharts".
    This folder contains piecharts of the different waters interacting (with waterid) for each waterbridge interaction in form of .png image files.
    
    .. figure:: /_static/images/Analysis/59ARGA_4192_Acceptor_waterbridge.png
        :figwidth: 725px
        :align: center

Binding_Modes_Markov_States:
    This folder contains a .png image of all binding modes found in the markov state analysis aswell as .png images of the markov chain plots.
    
    .. figure:: /_static/images/Analysis/all_binding_modes_arranged.png
        :figwidth: 725px
        :align: center

    This figure shows all binding modes found in the markov state analysis. The binding modes are arranged by their occurence procentage in the trajectory. The 2D image of the ligand is coloured according to the interactions formed in this binding mode.

    .. figure:: /_static/images/Analysis/markov_chain_plot_1.png
        :figwidth: 725px
        :align: center
    The markov chain plot figures show the transition probabilities between the different binding modes. You will obtain four figures, each containing only transitions above a given cutoff. The cutoffs are 1%, 5%, and 10%.

Visualization files:
    These files are generated by OpenMMDL-Analysis for the visualization of interactions in form of point clouds. 
    The files are:
        - clouds.json = contains the information for the point clouds
        - interacting_waters.pdb = topology file for the point clouds visualization
        - interacting_waters.dcd = trajectory file for the point clouds visualization
        - interacting_waters.pkl = pickle file of the interacting water ids for the point clouds visualization


Visualization
------------------------------
The interactions between your ligand and receptor can be visualized as interaction point clouds displayed ontop of your trajectory.
Furthermore the visualization will display all waters that are involved in forming waterbridge interactions between your receptor and ligand.
Open the visualization using the following command:

.. code-block:: text
    openmmdl_visualization

The command will open a prepared jupyter notebook in your browser.
You will need to edit the following variables in the notebook (please note that the paths to the files need to be the absolute file paths):

.. code-block:: text
    json_file_path = path to the clouds.json file
    pdb_file_path = path to the interacting_waters.pdb file
    dcd_file_path = path to the interacting_waters.dcd file
    interacting_waters = path to the interacting_waters.pkl file
    ligname = name of the ligand in the topology file (same as for analysis unless the ligname in the original was '*' then pls use ligname = 'UNK')

After editing the variables, you can run the whole notebook and view the interactions in an NGL-widget. Here is an example of the visualization

.. figure:: /_static/images/Analysis/visualization.png
    :figwidth: 725px
    :align: center
    
(CDK2 receptor with ligand LS3 (PDB: 1KE7))
